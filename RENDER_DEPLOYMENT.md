# Deploying to Render

This guide will help you deploy your Wagtail Rich Media project to Render.

## Prerequisites

1. A [Render account](https://render.com) (free tier available)
2. Your project pushed to a Git repository (GitHub, GitLab, or Bitbucket)
3. Optional: AWS S3 bucket for media file storage (recommended for production)

## Deployment Steps

### Option 1: Using render.yaml (Recommended)

1. **Push your code to Git**
   ```bash
   git add .
   git commit -m "Prepare for Render deployment"
   git push
   ```

2. **Create a new Blueprint on Render**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New" → "Blueprint"
   - Connect your Git repository
   - Render will automatically detect the `render.yaml` file
   - Click "Apply" to create the services

3. **Configure Environment Variables**
   After the blueprint is applied, go to your web service settings and set:
   - `ALLOWED_HOSTS`: Your Render domain (e.g., `your-app.onrender.com`)
   - `WAGTAILADMIN_BASE_URL`: `https://your-app.onrender.com`
   
   Optional (for AWS S3):
   - `USE_S3`: `True`
   - `AWS_ACCESS_KEY_ID`: Your AWS access key
   - `AWS_SECRET_ACCESS_KEY`: Your AWS secret key
   - `AWS_STORAGE_BUCKET_NAME`: Your S3 bucket name
   - `AWS_S3_REGION_NAME`: Your AWS region (e.g., `us-east-1`)

### Option 2: Manual Setup

1. **Create a PostgreSQL Database**
   - Go to Render Dashboard
   - Click "New" → "PostgreSQL"
   - Name: `wagtail-rich-media-db`
   - Choose your plan (free tier available)
   - Click "Create Database"
   - Copy the "Internal Database URL"

2. **Create a Web Service**
   - Click "New" → "Web Service"
   - Connect your Git repository
   - Configure:
     - **Name**: `wagtail-rich-media`
     - **Runtime**: Python 3
     - **Build Command**: `./build.sh`
     - **Start Command**: `gunicorn my_cms_project.wsgi:application`
     - **Instance Type**: Choose your plan

3. **Add Environment Variables**
   In the web service settings, add:
   ```
   PYTHON_VERSION=3.11.9
   DJANGO_SETTINGS_MODULE=my_cms_project.settings.production
   SECRET_KEY=[auto-generated by Render]
   DEBUG=False
   ALLOWED_HOSTS=your-app.onrender.com
   DATABASE_URL=[paste Internal Database URL from step 1]
   WAGTAILADMIN_BASE_URL=https://your-app.onrender.com
   USE_S3=False
   DJANGO_SUPERUSER_USERNAME=admin
   DJANGO_SUPERUSER_EMAIL=admin@example.com
   DJANGO_SUPERUSER_PASSWORD=[your-secure-password]
   ```

4. **Deploy**
   - Click "Create Web Service"
   - Render will automatically build and deploy your app

## Post-Deployment

### Automatic Superuser Creation

A superuser is automatically created during deployment using the environment variables:
- **Username**: Set via `DJANGO_SUPERUSER_USERNAME` (default: admin)
- **Email**: Set via `DJANGO_SUPERUSER_EMAIL` (default: admin@example.com)
- **Password**: Set via `DJANGO_SUPERUSER_PASSWORD` (you must set this!)

**Important**: Make sure to set a secure password in the `DJANGO_SUPERUSER_PASSWORD` environment variable before deployment.

### Manual Superuser Creation (Optional)

If you need to create additional admin users:

1. Go to your web service in Render Dashboard
2. Click "Shell" tab
3. Run:
   ```bash
   python manage.py createsuperuser
   ```
4. Follow the prompts to create your admin account

### Access Your Site

- **Frontend**: `https://your-app.onrender.com`
- **Admin**: `https://your-app.onrender.com/admin`

## Media Files Storage

### Option 1: Local Storage (Not Recommended for Production)

By default, media files are stored locally. This works but has limitations:
- Files are lost when the service restarts
- Not suitable for multiple instances
- Limited disk space

### Option 2: AWS S3 (Recommended)

1. **Create an S3 Bucket**
   - Go to AWS S3 Console
   - Create a new bucket
   - Configure CORS if needed
   - Create an IAM user with S3 access

2. **Update Environment Variables**
   ```
   USE_S3=True
   AWS_ACCESS_KEY_ID=your-access-key
   AWS_SECRET_ACCESS_KEY=your-secret-key
   AWS_STORAGE_BUCKET_NAME=your-bucket-name
   AWS_S3_REGION_NAME=us-east-1
   ```

3. **Redeploy**
   - Render will automatically redeploy when you update environment variables

## Troubleshooting

### Build Fails

- Check the build logs in Render Dashboard
- Ensure all dependencies are in `requirements.txt`
- Verify `build.sh` has execute permissions

### Static Files Not Loading

- Ensure `ALLOWED_HOSTS` includes your Render domain
- Check that `collectstatic` ran successfully in build logs
- Verify WhiteNoise is in `MIDDLEWARE` (already configured)

### Database Connection Issues

- Verify `DATABASE_URL` is correctly set
- Check that the database is running
- Ensure `psycopg2-binary` is in requirements.txt

### Media Files Not Uploading

- If using local storage, this is expected behavior on Render
- Switch to S3 for persistent media storage
- Verify S3 credentials if using AWS

## Updating Your App

To deploy updates:

1. Make your changes locally
2. Commit and push to Git:
   ```bash
   git add .
   git commit -m "Your update message"
   git push
   ```
3. Render will automatically detect the changes and redeploy

## Cost Considerations

- **Free Tier**: Includes 750 hours/month of web service + PostgreSQL database
- **Paid Plans**: Start at $7/month for web service, $7/month for database
- **Note**: Free tier services spin down after 15 minutes of inactivity

## Additional Resources

- [Render Documentation](https://render.com/docs)
- [Django Deployment Checklist](https://docs.djangoproject.com/en/stable/howto/deployment/checklist/)
- [Wagtail Deployment Guide](https://docs.wagtail.org/en/stable/advanced_topics/deploying.html)
